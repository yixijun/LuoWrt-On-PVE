# LuoWrt 脚本架构检测功能更新

## 📋 更新概述

本次更新为 LuoWrt 自动安装脚本添加了以下核心功能：
1. **自动系统架构检测**
2. **架构相关的文件匹配**
3. **改进的用户交互流程**
4. **支持多种架构类型**

## 🏗️ 新增功能详情

### 1. 自动架构检测
- **支持的架构**: amd64 (x86_64), arm64 (aarch64), arm (armv7)
- **检测方法**:
  - 主要使用 `uname -m` 命令
  - 备用方法：分析 `/proc/cpuinfo` 中的CPU信息
- **智能回退**: 如果自动检测失败，提供手动选择选项

### 2. 架构相关文件匹配
- **文件模式增强**: 文件匹配模式现在包含架构标识符
- **多名称支持**: 同时支持标准名称和别名（如 amd64 和 x86_64）
- **精确匹配**: 确保下载的固件与系统架构兼容

### 3. 用户界面改进
- **架构信息显示**: 在配置确认中显示检测到的架构
- **实时反馈**: 显示正在搜索的架构类型
- **错误提示**: 对不支持的架构提供明确的警告信息

## 🔄 修改的流程

### 之前流程：
1. PVE环境检查
2. 获取release信息
3. 选择ROM版本
4. **立即下载ROM** ← 低效
5. 获取存储池信息
6. 配置虚拟机
7. 确认创建

### 现在流程：
1. PVE环境检查
2. **自动检测系统架构** ← 新增
3. 获取release信息
4. 选择ROM版本
5. 获取存储池信息
6. 配置虚拟机
7. **显示完整配置（含架构）并确认**
8. **一次性下载和创建** ← 优化

## 📁 新增函数

### `detect_system_architecture()`
- 功能：自动检测当前系统架构
- 支持多种检测方法
- 提供详细的架构兼容性信息

### `select_architecture()`
- 功能：手动选择架构（当自动检测失败时）
- 提供清晰的选项说明
- 支持所有主流架构类型

## 🎯 文件匹配模式

### EFI 模式：
```bash
# img.gz 格式
.*LuoWrt-${ROM_SIZE}.*(${SYSTEM_ARCH}|${ARCH_ALIAS}).*-efi.*\.img\.gz

# qcow2 格式
.*LuoWrt-${ROM_SIZE}.*(${SYSTEM_ARCH}|${ARCH_ALIAS}).*-efi.*\.qcow2$
```

### BIOS 模式：
```bash
# img.gz 格式（排除EFI版本）
.*LuoWrt-${ROM_SIZE}.*(${SYSTEM_ARCH}|${ARCH_ALIAS})[^e]*\.img\.gz

# qcow2 格式（排除EFI版本）
.*LuoWrt-${ROM_SIZE}.*(${SYSTEM_ARCH}|${ARCH_ALIAS})[^e]*\.qcow2$
```

## 🖥️ 用户界面改进

### 配置确认页面现在显示：
```
配置确认:
VM ID: 101
系统架构: amd64 (x86_64)      ← 新增
ROM版本: 512MB
文件格式: img.gz
启动方式: bios
存储池: local-lvm
CPU: 2 cores
Memory: 1024MB
启动虚拟机: 否
```

## ⚠️ 重要提示

### 架构兼容性：
- **amd64 (x86_64)**: PVE 完全支持 ✅
- **arm64 (aarch64)**: 需要PVE版本支持ARM虚拟化 ⚠️
- **arm (armv7)**: PVE 支持有限 ⚠️

### 回退机制：
1. 自动检测失败 → 手动选择
2. 架构特定文件未找到 → 尝试通用匹配
3. 所有匹配失败 → 清晰错误提示

## 🔧 技术细节

### 变量新增：
```bash
SYSTEM_ARCH=""     # 主要架构名称 (amd64, arm64, arm)
ARCH_ALIAS=""      # 架构别名 (x86_64, aarch64, armv7)
```

### 文件名示例：
```
LuoWrt-512-amd64-generic-efi.img.gz     ← amd64 EFI版本
LuoWrt-3072-x86_64-generic.img.gz      ← x86_64 BIOS版本
LuoWrt-512-arm64-generic-efi.img.gz    ← arm64 EFI版本
LuoWrt-3072-aarch64-generic.img.gz     ← aarch64 BIOS版本
```

## ✅ 测试验证

- ✅ 语法检查通过
- ✅ 架构检测功能测试通过
- ✅ 文件匹配模式验证通过
- ✅ 用户界面显示正确

## 📈 性能优化

1. **避免重复下载**: 延迟下载到最终确认后
2. **精确匹配**: 减少不匹配文件的下载尝试
3. **智能缓存**: 保持原有的文件存在性检查

---

**更新完成时间**: 2025-12-14
**版本**: v1.1
**兼容性**: 保持向后兼容